---
import Layout from '@layouts/Layout.astro';
export const prerender = false;
---

<Layout title="Importar Miembros">
  <main class="container mx-auto p-4  text-slate-100">
    <h1 class="text-2xl font-bold mb-4">Importar Miembros desde JSON</h1>
    <p class="mb-4">
      Haz clic en el botón de abajo para iniciar la importación de los miembros
      desde el archivo <code>ovejas.json</code>.
    </p>
    <p class="mb-4">
        Se omitirán los miembros cuya cédula ya exista en la base de datos.
    </p>

    <form id="import-form">
      <button type="submit" id="import-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
        Importar Miembros
      </button>
    </form>

    <div id="result-message" class="mt-4 p-4 rounded hidden"></div>
  </main>

  <script>
    const form = document.getElementById('import-form');
    const button = document.getElementById('import-button') as HTMLButtonElement;
    const resultMessage = document.getElementById('result-message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      button.disabled = true;
      button.textContent = 'Importando...';
      resultMessage.classList.add('hidden');

      try {
        const response = await fetch('/api/importar', {
          method: 'POST',
        });

        const data = await response.json();

        if (response.ok) {
          resultMessage.textContent = `¡Éxito! Se importaron ${data.importedCount} nuevos miembros. Se omitieron ${data.skippedCount} duplicados.`;
          resultMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700');
          resultMessage.classList.add('bg-green-100', 'text-green-700');
        } else {
          throw new Error(data.message || 'Ocurrió un error desconocido.');
        }
      } catch (error) {
        resultMessage.textContent = `Error: ${error.message}`;
        resultMessage.classList.remove('hidden', 'bg-green-100', 'text-green-700');
        resultMessage.classList.add('bg-red-100', 'text-red-700');
      } finally {
        button.disabled = false;
        button.textContent = 'Importar Miembros';
      }
    });
  </script>
</Layout>
